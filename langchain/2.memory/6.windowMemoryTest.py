from callFunction import *  # *: 모듈내에 있는 모든 요소 (클래스, 함수, ...)
# 다른 모듈 (여러 메시지를 통째로 삽입하는 자리표시자)
from langchain_core.prompts import MessagesPlaceholder  
# 추가 (대화 기록 전체 저장)
from langchain.memory import ConversationBufferWindowMemory

llm = ChatOpenAI(model="gpt-4o-mini")  # OpenAI 채팅 모델 객체 생성

# 메모리 전체 기억 ((최근 대화 k=2개만 저장, return_messages=True로 메시지 형태 반환)
memory = ConversationBufferWindowMemory(k=2, return_messages=True) 

prompt = ChatPromptTemplate.from_messages([  # 채팅 프롬프트 구조 정의
    ("system", "당신은 여행 전문가입니다. 질문에 친절하게 답변해 주세요."), # 시스템 역할 정의
    MessagesPlaceholder(variable_name="history"), # history 메모리에 저장된 값을 꺼내 와라
    ("human", "{input}")
])

chain = prompt | llm 

# 연속 대화 시뮬레이션 (사용자 입력을 순차적으로 물어보게 코딩)
inputs = [
    "부산 여행지 추천해 줘.", 
    "대한민국의 수도는 어디야?", 
    "서울의 인구는 몇명이야?", 
    "내가 전에 추천요청한 부산 여행지 알지?"
]

for user_input in inputs:
    # 메모리에 저장된 갑을 꺼내 와라 (매개변수값(딕셔너리객체))
    #   -> 입력받은 값이 없다는 표시 ex) {"input": "안녕하세요"}
    # 반환받을 때 딕셔너리의 키 중 하나가 "history" 키값으로 저장된 값을 꺼내 와라
    #   ex) {"history": "사용자: 부산 여행지 추천해 줘."}
    history = memory.load_memory_variables({})["history"]
    # 새롭게 입력을 받을 때마다 이전에 저장된 데이터를 같이 전달
    result = chain.invoke({"history": history, "input": user_input}) 
    # 결과 출력
    print(f"\n사용자:{user_input}\n응답:{result.content}")
    # 메모리에 저장 (현재 입력값과 모델 응답값을 계속해서 요청할 때마다 누적해서 저장)
    memory.save_context({"input": user_input}, {"output": result.content}) # 출력 문자열만 저장
    
    '''
    사용자:부산 여행지 추천해 줘.
응답:부산은 아름다운 해변과 풍부한 문화유산이 어우러져 있어 매력적인 여행지입니다. 아래는 부산에서 추천할 만한 여행지 몇 곳입니다.

1. **해운대 해수욕장**: 부산의 대표적인 해수욕장으로, 깨끗한 해변과 아름다운 바다 풍경으로 유명합니다. 여름에는 다양한 해양 스포츠와 행사도 열립니다.

2. **광안리 해수욕장**: 해운대와는 또 다른 매력을 가진 해변으로, 광안대교의 야경이 특히 아름답습니 다. 카페와 레스토랑이 많아 즐길 거리도 많습니다.

3. **부산 타워**: 용두산 공원 내 위치한 타워로, 부산 시내와 항구의 파노라마 뷰를 감상할 수 있는 좋 은 장소입니다.

4. **감천문화마을**: 아기자기한 컬러풀한 집들이 인상적인 마을로, 사진 찍기 좋은 스팟이 많습니다. 예술작품과 벽화가 곳곳에 있어 탐방에 재미를 더합니다.

5. **자갈치 시장**: 부산의 대표적인 수산물 시장으로, 신선한 해산물을 맛볼 수 있는 장소입니다. 다양 한 해산물 요리를 시식해보시는 것도 추천드립니다.

6. **부산국제영화제(BIFF) 광장**: 영화와 관련된 행사와 전시가 자주 열리는 곳으로, 부산 국제영화제가 열리면 많은 관광객이 찾습니다.

7. **동래온천**: 부산의 대표적인 온천 지역으로, 피로를 푸는 데 좋은 곳입니다. 온천탕과 마사지 시설 이 잘 갖춰져 있습니다.

8. **태종대**: 절경을 자랑하는 해안 절벽으로, 아름다운 자연 풍경과 함께 등대도 구경할 수 있습니다. 트레킹 코스도 있어 산책하기 좋습니다.

부산은 먹거리도 풍부하니, 다양한 해산물 요리와 지역 음식을 꼭 맛보세요! 즐거운 여행 되시길 바랍니다!

사용자:대한민국의 수도는 어디야?
응답:대한민국의 수도는 서울입니다. 서울은 정치, 경제, 문화의 중심지로, 많은 역사적 유적지와 현대적 인 시설이 어우러진 도시입니다. 서울의 주요 관광지로는 경복궁, 명동, 남산, 한강 등이 있습니다.      

사용자:서울의 인구는 몇명이야?
응답:2023년 기준으로 서울의 인구는 대략 9백만 명 이상입니다. 그러나 인구는 지속적으로 변화하고 있으므로, 최신 통계는 서울특별시청이나 통계청의 공식 웹사이트를 참조하시는 것이 가장 정확합니다. 서울은 대한민국에서 가장 인구가 많은 도시이며, 다양한 문화와 활기찬 도시 생활로 유명합니다.

사용자:내가 전에 추천요청한 부산 여행지 알지?
응답:죄송하지만, 이전 대화 내용은 기억하지 못합니다. 다시 한 번 말씀해 주신다면 부산 여행지에 대한 추천을 드릴 수 있습니다. 부산은 아름다운 해변과 맛있는 음식, 다양한 관광명소로 유명한 도시입니다.  어떤 종류의 여행지를 원하시는지 알려주시면 더욱 정확한 추천을 드릴 수 있을 것 같습니다!

'''
    